name: Android Release (Play)

on:
  workflow_dispatch:
    inputs:
      track:
        description: "Play track (internal, alpha, beta, production)"
        required: true
        default: "internal"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Decode signing keystore
        shell: bash
        run: |
          set -euxo pipefail
          echo "${SIGNING_KEYSTORE_BASE64}" | base64 --decode > "$GITHUB_WORKSPACE/release.keystore.jks"
        env:
          SIGNING_KEYSTORE_BASE64: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}

      - name: Write Play service account JSON
        shell: bash
        run: |
          set -euxo pipefail
          echo "${PLAY_SERVICE_ACCOUNT_JSON_BASE64}" | base64 --decode > "$GITHUB_WORKSPACE/play-service-account.json"
        env:
          PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}

      - name: Build Release AAB
        shell: bash
        run: |
          set -euxo pipefail
          ./gradlew :app:bundleRelease
        env:
          SIGNING_STORE_FILE: ${{ github.workspace }}/release.keystore.jks
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      - name: Upload Release AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/*.aab
          if-no-files-found: error

      - name: Upload to Google Play (internal/alpha/beta/production)
        shell: bash
        run: |
          set -euxo pipefail
          ./gradlew :app:publishReleaseBundle
        env:
          PLAY_SERVICE_ACCOUNT_JSON_FILE: ${{ github.workspace }}/play-service-account.json
          PLAY_TRACK: ${{ inputs.track }}
          SIGNING_STORE_FILE: ${{ github.workspace }}/release.keystore.jks
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

